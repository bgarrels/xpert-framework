<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:cc="http://java.sun.com/jsf/composite"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html">

    <!-- INTERFACE -->
    <cc:interface>
        <cc:attribute name="for" required="true" />
        <cc:attribute name="collapsed" type="boolean" default="true" />
    </cc:interface>

    <!-- IMPLEMENTATION -->
    <cc:implementation>
        <span id="#{cc.attrs.clientId}">
            <h:panelGroup rendered="#{auditBean.isPersisted(cc.attrs.for)}" id="auditingPanel">
                <p:spacer height="3" />
                <h:panelGroup id="detail">

                    <p:commandButton process="@this" action="#{auditBean.detail}" icon="ui-icon-plus"
                                     rendered="#{cc.attrs.collapsed}"
                                     styleClass="button-detail-auditing" style="margin-bottom: 2px;"
                                     oncomplete="$(PrimeFaces.escapeClientId('#{cc.attrs.clientId}')).find('.button-detail-auditing').hide();$(PrimeFaces.escapeClientId('#{cc.attrs.clientId}')).find('.panel-detail-auditing').show()"
                                     update="accordionDetail" value="#{xmsg.auditing}" >
                        <f:setPropertyActionListener value="#{cc.attrs.for}" target="#{auditBean.object}" />
                    </p:commandButton>

                    <h:panelGroup rendered="#{not cc.attrs.collapsed}">
                        <f:event type="preRenderComponent" listener="#{auditBean.detail(cc.attrs.for)}" />
                    </h:panelGroup>

                    <h:panelGroup styleClass="panel-detail-auditing" style="#{cc.attrs.collapsed ? 'display: none;' : ''}">
                        <p:accordionPanel id="accordionDetail" >
                            <p:tab title="#{xmsg.auditingDetail}">

                                <p:dataTable var="audit" value="#{auditBean.auditings}" styleClass="datatable-auditing"
                                             emptyMessage="#{xmsg.noRecordFound}"  
                                             rowsPerPageTemplate="10,20,30" rowIndexVar="index"
                                             paginator="true" paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                             currentPageReportTemplate=" "
                                             rows="10" paginatorPosition="bottom" >

                                    <p:column style="width: 20px;">
                                        <p:commandButton type="button" title="#{xmsg.detail}" style="font-size: 9px;"
                                                         icon="ui-icon-plus" onclick="$(this).closest('tr').next('tr').toggle('fast');" />
                                    </p:column>
                                    <p:column style="text-align: center;" sortBy="#{audit.eventDate}" headerText="#{xmsg.date}" >
                                        <h:outputText value="#{audit.eventDate}" >
                                            <f:convertDateTime dateStyle="medium" type="both"/>
                                        </h:outputText>
                                    </p:column>
                                    <p:column style="text-align: center;" sortBy="#{audit.auditingType}" headerText="#{xmsg.type}" >
                                        <h:outputText value="#{xmsg[audit.auditingType.description]}" />
                                    </p:column>
                                    <p:column headerText="#{xmsg['user']}">
                                        <h:outputText value="#{audit.user}" />
                                    </p:column>
                                    <p:summaryRow>  
                                        <p:column colspan="4">  
                                            <p:dataTable var="metadata" emptyMessage="#{xmsg.noRecordFound}"
                                                         value="#{audit.metadatas}" rowIndexVar="indexMetadata">
                                                <p:column style="text-align: center;">
                                                    <h:outputText value="#{indexMetadata+1}" />
                                                </p:column>
                                                <p:column headerText="#{xmsg.field}">
                                                    <h:outputText value="#{metadata.field}" />
                                                </p:column>
                                                <p:column headerText="#{xmsg.oldValue}">
                                                    <h:outputText value="#{metadata.oldValue}" />
                                                </p:column>
                                                <p:column headerText="#{xmsg.newValue}">
                                                    <h:outputText value="#{metadata.newValue}" />
                                                </p:column>
                                            </p:dataTable>
                                        </p:column>
                                    </p:summaryRow>
                                </p:dataTable>
                                <script>
                                    /*<![CDATA[*/
                                    $(function() {
                                        var $elements = $(".datatable-audit td.table-audit-column");
                                        $.each($elements, function(i, element) {
                                            var $tr = $(element).parent();
                                            $tr.after("<tr><td colspan='3'>"+$(element).html()+"</tr></td>");
                                            $(element).remove();
                                        });
                                        $(".datatable-audit th:first").remove();
                                    });
                                    /*]]>*/
                                </script>
                            </p:tab>
                        </p:accordionPanel>
                    </h:panelGroup>
                </h:panelGroup>
            </h:panelGroup>
        </span>
    </cc:implementation>
</html>